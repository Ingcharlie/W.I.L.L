<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>debug_will &#8212; W.I.L.L 3.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for debug_will</h1><div class="highlight"><pre>
<span></span><span class="c1"># External imports</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">send_from_directory</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">flask_socketio</span> <span class="k">import</span> <span class="n">SocketIO</span>
<span class="kn">from</span> <span class="nn">flask_socketio</span> <span class="k">import</span> <span class="n">join_room</span><span class="p">,</span> <span class="n">leave_room</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">make_response</span>
<span class="kn">import</span> <span class="nn">dataset</span>
<span class="kn">import</span> <span class="nn">bcrypt</span>

<span class="c1"># Internal imports</span>
<span class="kn">import</span> <span class="nn">tools</span>
<span class="kn">import</span> <span class="nn">core</span>

<span class="c1"># Builtin imports</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">Queue</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">queue</span> <span class="k">as</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">logging.handlers</span> <span class="k">import</span> <span class="n">RotatingFileHandler</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">signal</span>

<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Load the will.conf file</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;debug_will.conf&quot;</span><span class="p">):</span>
    <span class="n">data_string</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;debug_will.conf&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data_string</span><span class="p">)</span>
    <span class="n">configuration_data</span> <span class="o">=</span> <span class="n">json_data</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Couldn&#39;t find will.conf file, exiting&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">logfile</span> <span class="o">=</span> <span class="n">configuration_data</span><span class="p">[</span><span class="s2">&quot;logfile&quot;</span><span class="p">]</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">filemode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
<span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="c1">#log = logging.getLogger()</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">RotatingFileHandler</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">maxBytes</span><span class="o">=</span><span class="mi">10000000</span><span class="p">,</span> <span class="n">backupCount</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">))</span>
<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">configuration_data</span><span class="p">[</span><span class="s2">&quot;secret_key&quot;</span><span class="p">]</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">logger</span>
<span class="n">db_url</span> <span class="o">=</span> <span class="n">configuration_data</span><span class="p">[</span><span class="s2">&quot;db_url&quot;</span><span class="p">]</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_url</span><span class="p">)</span>
<span class="n">core</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>

<span class="n">socketio</span> <span class="o">=</span> <span class="n">SocketIO</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="n">gmtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">()</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2"> UTC </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gmtime</span><span class="o">.</span><span class="n">tm_hour</span><span class="p">,</span> <span class="n">gmtime</span><span class="o">.</span><span class="n">tm_min</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y&quot;</span><span class="p">))</span>

<span class="nd">@atexit</span><span class="o">.</span><span class="n">register</span>
<div class="viewcode-block" id="dump_events"><a class="viewcode-back" href="../will.html#debug_will.dump_events">[docs]</a><span class="k">def</span> <span class="nf">dump_events</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Dump events to db on exit</span>
<span class="sd">    :return:</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:SYS:Dumping events&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">core</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;function&quot;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;:SYS:Dumping event </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
            <span class="n">db</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upsert</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span></div>

<span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">dump_events</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/new_user&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<div class="viewcode-block" id="new_user"><a class="viewcode-back" href="../will.html#debug_will.new_user">[docs]</a><span class="k">def</span> <span class="nf">new_user</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    /api/new_user</span>
<span class="sd">    :return:</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:API:/api/new_user&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Username is </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
        <span class="n">first_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;first_name&quot;</span><span class="p">]</span>
        <span class="n">last_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;last_name&quot;</span><span class="p">]</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>
        <span class="n">city</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">]</span>
        <span class="n">country</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempting to create new user with username </span><span class="si">{0}</span><span class="s2"> and email </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>
        <span class="c1"># Check to see if the username exists</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">users</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">):</span>
            <span class="c1"># If that username is already taken</span>
            <span class="n">taken_message</span> <span class="o">=</span> <span class="s2">&quot;Username </span><span class="si">{0}</span><span class="s2"> is already taken&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">taken_message</span><span class="p">)</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">taken_message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add the new user to the database</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:Adding a new user to the database&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
            <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
            <span class="c1"># Hash the password</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Hashing password&quot;</span><span class="p">)</span>
            <span class="n">hashed</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">password</span><span class="p">),</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">gensalt</span><span class="p">())</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Hashed password is </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hashed</span><span class="p">))</span>
            <span class="n">is_admin</span> <span class="o">=</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">configuration_data</span><span class="p">[</span><span class="s2">&quot;admins&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">db</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span>
                    <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
                    <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="n">first_name</span><span class="p">,</span>
                    <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="n">last_name</span><span class="p">,</span>
                    <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
                    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">hashed</span><span class="p">,</span>
                    <span class="s2">&quot;admin&quot;</span><span class="p">:</span> <span class="n">is_admin</span><span class="p">,</span>
                    <span class="s2">&quot;default_plugin&quot;</span><span class="p">:</span> <span class="s2">&quot;search&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;notifications&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="s2">&quot;email&quot;</span><span class="p">]),</span>
                    <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;REMOTE_ADDR&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;news_site&quot;</span><span class="p">:</span> <span class="s2">&quot;http://reuters.com&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="n">city</span><span class="p">,</span>
                    <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="n">country</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span>
                    <span class="s2">&quot;temp_unit&quot;</span><span class="p">:</span> <span class="s2">&quot;fahrenheit&quot;</span>
                <span class="p">})</span>
                <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
                <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Thank you </span><span class="si">{0}</span><span class="s2">, you are now registered for W.I.L.L&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">first_name</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Needed data not found in new user request&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Couldn&#39;t find required data in request. &quot;</span> \
                           <span class="s2">&quot;To create a new user, a username, password, first name, last name,&quot;</span> \
                           <span class="s2">&quot;and email is required&quot;</span>
    <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">return_json</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/signup&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="signup"><a class="viewcode-back" href="../will.html#debug_will.signup">[docs]</a><span class="k">def</span> <span class="nf">signup</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:API:/api/signup&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;signup.html&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="gen_session"><a class="viewcode-back" href="../will.html#debug_will.gen_session">[docs]</a><span class="k">def</span> <span class="nf">gen_session</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param username:</span>
<span class="sd">    :return: session_id</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">session_id</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_session_id</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="c1"># Start monitoring notifications</span>
    <span class="c1"># Register a session id</span>
    <span class="n">core</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="n">session_id</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
            <span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(),</span>
            <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s2">&quot;updates&quot;</span><span class="p">:</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(),</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">session_id</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">session_id</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/start_session&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<div class="viewcode-block" id="start_session"><a class="viewcode-back" href="../will.html#debug_will.start_session">[docs]</a><span class="k">def</span> <span class="nf">start_session</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate a session id and start a new session</span>
<span class="sd">    :return:</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:API:/api/start_session&quot;</span><span class="p">)</span>
    <span class="c1"># Check the information that the user has submitted</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">username</span> <span class="ow">and</span> <span class="n">password</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:Checking password&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span>
        <span class="n">user_data</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_data</span><span class="p">:</span>
            <span class="n">user_data</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
            <span class="c1"># Check the password</span>
            <span class="n">db_hash</span> <span class="o">=</span> <span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
            <span class="n">user_auth</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">password</span><span class="p">),</span> <span class="n">db_hash</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user_auth</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:Authentication successful&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
                <span class="c1"># Return the session id to the user</span>
                <span class="n">session_id</span> <span class="o">=</span> <span class="n">gen_session</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">session_id</span><span class="p">:</span>
                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Authentication successful&quot;</span>
                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Invalud username/password&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Couldn&#39;t find user with username </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Couldn&#39;t find username and password in request data&quot;</span>
    <span class="c1"># Render the response as json</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;session_data&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Rendering command template&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;command.html&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">return_json</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/check_session&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<div class="viewcode-block" id="check_session"><a class="viewcode-back" href="../will.html#debug_will.check_session">[docs]</a><span class="k">def</span> <span class="nf">check_session</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a session is valid</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:API:/api/check_session&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;session_id&quot;</span><span class="p">]</span>
        <span class="n">session_valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">session_id</span> <span class="ow">in</span> <span class="n">core</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="n">session_valid</span><span class="p">})</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
        <span class="k">if</span> <span class="n">session_valid</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Session id </span><span class="si">{0}</span><span class="s2"> is valid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Session id </span><span class="si">{0}</span><span class="s2"> is invalid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Couldn&#39;t find session_id in request data&quot;</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">return_json</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/end_session&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<div class="viewcode-block" id="end_session"><a class="viewcode-back" href="../will.html#debug_will.end_session">[docs]</a><span class="k">def</span> <span class="nf">end_session</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    End a users session</span>
<span class="sd">    :return:</span>
<span class="sd">    &#39;&#39;&#39;</span><span class="s1">&#39;&#39;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:API:/api/end_session&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;session_id&quot;</span><span class="p">]</span>
        <span class="c1"># Check for the session id in the core.sessions dictionary</span>
        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="n">core</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:Ending session&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session_id</span><span class="p">))</span>
            <span class="k">del</span> <span class="n">core</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ended session&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Session id </span><span class="si">{0}</span><span class="s2"> wasn&#39;t found in core.sessions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Couldn&#39;t find session id in request data&quot;</span>
    <span class="c1"># Render the response as json</span>
    <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">return_json</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>

<div class="viewcode-block" id="update_loop"><a class="viewcode-back" href="../will.html#debug_will.update_loop">[docs]</a><span class="k">def</span> <span class="nf">update_loop</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">sid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param session_id: W.I.L.L session id</span>
<span class="sd">    :param sid: Flask session id</span>
<span class="sd">    Update thread that will emit socket.io updates to the user while they&#39;re connected</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="n">core</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">session_data</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1">#Session ended while loop was sleeping</span>
            <span class="k">break</span>
        <span class="n">session_updates</span> <span class="o">=</span> <span class="n">session_data</span><span class="p">[</span><span class="s2">&quot;updates&quot;</span><span class="p">]</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">session_updates</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">update</span> <span class="o">=</span> <span class="n">session_updates</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Pushing update </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">update</span><span class="p">))</span>
            <span class="n">socketio</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">room</span><span class="o">=</span><span class="n">sid</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:Ending updates for finished session&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session_id</span><span class="p">))</span></div>

<span class="nd">@socketio</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">disconnect_session</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    End the webapp session and the update thread on the users disconnect from the page</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:SOCKET:disconnect&quot;</span><span class="p">)</span>
    <span class="n">session_id</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;session_id&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="n">core</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:Ending session&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session_id</span><span class="p">))</span>
        <span class="k">del</span> <span class="n">core</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:Session id wasn&#39;t found in core.sessions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session_id</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/settings&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<div class="viewcode-block" id="settings"><a class="viewcode-back" href="../will.html#debug_will.settings">[docs]</a><span class="k">def</span> <span class="nf">settings</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Change the users settings</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:API:/api/settings&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="k">if</span> <span class="s2">&quot;username&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;password&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
        <span class="n">user_table</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_table</span><span class="p">:</span>
            <span class="n">db_hash</span> <span class="o">=</span> <span class="n">user_table</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">password</span><span class="p">),</span> <span class="n">db_hash</span><span class="p">):</span>
                <span class="c1">#TODO: write a framework that allowc ahgning of notifications</span>
                <span class="n">immutable_settings</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;user_token&quot;</span><span class="p">,</span> <span class="s2">&quot;notifications&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">]</span>
                <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:Changing settings for user&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">setting</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">immutable_settings</span><span class="p">:</span>
                            <span class="n">db</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upsert</span><span class="p">({</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="n">setting</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="n">setting</span><span class="p">]},</span> <span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">])</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Updated settings&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">db_error</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Exception </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2"> occurred while trying to commit changes to the database&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">db_error</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">db_error</span><span class="o">.</span><span class="n">args</span>
                    <span class="p">))</span>
                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Error encountered while trying to update db, changes not committed&quot;</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;User </span><span class="si">{0}</span><span class="s2"> doesn&#39;t exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Couldn&#39;t find username or password in request data&quot;</span>
    <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">return_json</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/settings&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<div class="viewcode-block" id="settings_page"><a class="viewcode-back" href="../will.html#debug_will.settings_page">[docs]</a><span class="k">def</span> <span class="nf">settings_page</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the settings template</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:WEB:/settings&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;username&quot;</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;logged-in&quot;</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;logged-in&quot;</span><span class="p">]:</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;settings.html&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span></div>

<span class="nd">@socketio</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;get_updates&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_updates</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param data: socket.io data about the update thrad</span>
<span class="sd">    Authenticate and start the update thread</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:SOCKET:get_updates&quot;</span><span class="p">)</span>
    <span class="n">session_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;session_id&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">session_id</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="n">core</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1">#If the session id is valid</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">:Subscribing client </span><span class="si">{0}</span><span class="s2"> to updates for session_id&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;REMOTE_ADDR&quot;</span><span class="p">],</span> <span class="n">session_id</span>
            <span class="p">))</span>
            <span class="c1">#Keep running this loop while the session is active</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:Starting update loop&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session_id</span><span class="p">))</span>
            <span class="n">update_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">update_loop</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">sid</span><span class="p">))</span>
            <span class="n">update_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Session id </span><span class="si">{0}</span><span class="s2"> is invalid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session_id</span><span class="p">))</span>
            <span class="n">socketio</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;Error, invalid session id&quot;</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">socketio</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;Error, couldn&#39;t find session id in update request&quot;</span><span class="p">})</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">])</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
        <span class="n">user_table</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="n">db_hash</span> <span class="o">=</span> <span class="n">user_table</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">password</span><span class="p">),</span> <span class="n">db_hash</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:Logged in user&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
            <span class="c1">#Generate user token</span>
            <span class="n">session</span><span class="p">[</span><span class="s2">&quot;logged-in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">session</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
            <span class="n">user_token</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upsert</span><span class="p">({</span><span class="s2">&quot;username&quot;</span><span class="p">:</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;user_token&quot;</span><span class="p">:</span><span class="n">user_token</span><span class="p">},</span> <span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">])</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Authentication successful&quot;</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;user_token&quot;</span><span class="p">:</span><span class="n">user_token</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Invalid username/password&quot;</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Couldn&#39;t find username and password in request data&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:Setting cookies for username and user token&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;user_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;user_token&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">resp</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../will.html#debug_will.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the webapp index.html template</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:WEB:/&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;username&quot;</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">username</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:Found username cookies&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting session data&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;logged-in&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;logged-in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;welcome-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Welcome to W.I.L.L&quot;</span>
    <span class="k">if</span> <span class="n">username</span><span class="p">:</span>
        <span class="n">user_table</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;user_token&quot;</span> <span class="ow">in</span> <span class="n">user_table</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;user_token&quot;</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">user_token</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;user_token&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">user_table</span><span class="p">[</span><span class="s2">&quot;user_token&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_token</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:User authenticated via user_token in cookies&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
                <span class="n">new_token</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_user_token</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
                <span class="n">db</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upsert</span><span class="p">({</span><span class="s2">&quot;username&quot;</span><span class="p">:</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;user_token&quot;</span><span class="p">:</span> <span class="n">new_token</span><span class="p">},</span> <span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">])</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;logged-in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">user_first_name</span> <span class="o">=</span> <span class="n">user_table</span><span class="p">[</span><span class="s2">&quot;first_name&quot;</span><span class="p">]</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;welcome-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Welcome back </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_first_name</span><span class="p">)</span>
                <span class="n">session_id</span> <span class="o">=</span> <span class="n">gen_session</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;session_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_id</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;user_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_token</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:Generated session id for user </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">session_id</span><span class="p">,</span> <span class="n">username</span>
                <span class="p">))</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">resp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;User tokens don&#39;t match.</span><span class="se">\n</span><span class="si">{0}</span><span class="se">\n</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_token&quot;</span><span class="p">),</span>
                                                                     <span class="n">db</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)[</span><span class="s2">&quot;user_token&quot;</span><span class="p">]))</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;logged-in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find user token in cookies&quot;</span><span class="p">)</span>
            <span class="n">session</span><span class="p">[</span><span class="s2">&quot;logged-in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find username in cookies&quot;</span><span class="p">)</span>
        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;logged-in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1">#If the cookies aren&#39;t found</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/report&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<div class="viewcode-block" id="report"><a class="viewcode-back" href="../will.html#debug_will.report">[docs]</a><span class="k">def</span> <span class="nf">report</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render template for admin-only reporting page or bounce a non admin user back to /</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:WEB:/report&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;username&quot;</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;logged-in&quot;</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;logged-in&quot;</span><span class="p">]:</span>
        <span class="n">user_table</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">user_table</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user_table</span><span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">]:</span>
                <span class="c1">#Get the session_data</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;commands-processed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">processed_commands</span>
                <span class="n">time_str</span> <span class="o">=</span> <span class="n">start_time</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;start-time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_time</span>
                <span class="n">users_online</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">users_processed</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="n">core</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="n">session_data</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
                    <span class="n">session_user</span> <span class="o">=</span> <span class="n">session_data</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">session_user</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">users_processed</span><span class="p">:</span>
                        <span class="n">users_processed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">session_user</span><span class="p">))</span>
                        <span class="n">users_online</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;users-online&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">users_online</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;active-sessions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">sessions</span><span class="p">)</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">error_num</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">success_num</span>
                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;users-list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">users_processed</span>
                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;report.html&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/command&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<div class="viewcode-block" id="command"><a class="viewcode-back" href="../will.html#debug_will.command">[docs]</a><span class="k">def</span> <span class="nf">command</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deprecated non-styled page for commands</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:WEB:command&quot;</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
    <span class="n">user_table</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
    <span class="n">db_hash</span> <span class="o">=</span> <span class="n">user_table</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">password</span><span class="p">),</span> <span class="n">db_hash</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:Starting session for user&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
        <span class="n">session_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">start_session</span><span class="p">())</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">session_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;session_id&quot;</span><span class="p">]</span>
        <span class="n">session</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;session_id&quot;</span><span class="p">:</span><span class="n">session_id</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;command.html&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Invalid password&quot;</span></div>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/command&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<div class="viewcode-block" id="process_command"><a class="viewcode-back" href="../will.html#debug_will.process_command">[docs]</a><span class="k">def</span> <span class="nf">process_command</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Api path for processing a command</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:API:/api/command&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;session_id&quot;</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{1}</span><span class="s2">:Processing command </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">session_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="n">core</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># Add the command to the core.sessions command queue</span>
            <span class="n">session_data</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{1}</span><span class="s2">:Adding command </span><span class="si">{0}</span><span class="s2"> to the command queue&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">session_id</span><span class="p">))</span>
            <span class="n">command_id</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_command_id</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
            <span class="n">command_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">command_id</span><span class="p">,</span>
                <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">command</span>
            <span class="p">}</span>
            <span class="n">command_response</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">sessions_monitor</span><span class="o">.</span><span class="n">command</span><span class="p">(</span>
                <span class="n">command_data</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">],</span> <span class="n">db</span><span class="p">,</span> <span class="n">add_to_updates_queue</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">session_data</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">command_data</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:Returning command response </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">tools</span><span class="o">.</span><span class="n">fold</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">command_response</span><span class="p">))))</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">command_response</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">:Couldn&#39;t find session id in sessions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session_id</span><span class="p">))</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Invalid session id&quot;</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find session id and command in request data&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Couldn&#39;t find session id and command in request data&quot;</span>
    <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">return_json</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get_sessions&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<div class="viewcode-block" id="get_sessions"><a class="viewcode-back" href="../will.html#debug_will.get_sessions">[docs]</a><span class="k">def</span> <span class="nf">get_sessions</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return list of active sessions for user</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:API:/api/get_sessions&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="n">sessions</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">sessions</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
        <span class="n">db_hash</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
        <span class="n">user_auth</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">password</span><span class="p">),</span> <span class="n">db_hash</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_auth</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;sessions&quot;</span><span class="p">:[]})</span>
            <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sessions</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">username</span><span class="p">:</span>
                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;sessions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Fetched active sessions&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Invalid username/password combination&quot;</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Couldn&#39;t find username and password in request&quot;</span>
    <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">return_json</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>

<div class="viewcode-block" id="start"><a class="viewcode-back" href="../will.html#debug_will.start">[docs]</a><span class="k">def</span> <span class="nf">start</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize db and session monitor thread</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:SYS:Starting W.I.L.L&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:SYS:Loaded configuration file and started logging&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:SYS:Connecting to database&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:SYS:Starting W.I.L.L core&quot;</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:SYS:Starting sessions parsing thread&quot;</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">sessions_monitor</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:SYS:Connected to database, running server&quot;</span><span class="p">)</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">start</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;:SYS:Running app&quot;</span><span class="p">)</span>
    <span class="n">socketio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">configuration_data</span><span class="p">[</span><span class="s2">&quot;host&quot;</span><span class="p">],</span> <span class="n">port</span><span class="o">=</span><span class="n">configuration_data</span><span class="p">[</span><span class="s2">&quot;port&quot;</span><span class="p">],</span> <span class="n">debug</span><span class="o">=</span><span class="n">configuration_data</span><span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">])</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Will Beddow.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>